name: Create ECR Repository

on:
  workflow_dispatch:

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  REGION: ${{ secrets.REGION }}

jobs:
  create-ecr-repository:
    name: Check and Create ECR Repository
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}

      - id: string
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ github.event.repository.name }}

      - name: Check and create ECR repository
        id: ecr-repo
        run: |
          REPO_NAME="${{ steps.string.outputs.lowercase }}"
          REGION="${{ env.REGION }}"
          
          echo "ğŸ” Checking ECR repository: $REPO_NAME in region: $REGION"
          
          # Verificar si el repositorio existe
          if aws ecr describe-repositories --repository-names $REPO_NAME --region $REGION 2>/dev/null; then
            echo "âœ… Repository already exists: $REPO_NAME"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "created=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Repository does not exist, creating: $REPO_NAME"
            aws ecr create-repository \
              --repository-name $REPO_NAME \
              --region $REGION \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256 \
              --image-tag-mutability MUTABLE
            
            echo "âœ… Repository created successfully: $REPO_NAME"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "created=true" >> $GITHUB_OUTPUT
          fi
          
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: ECR Repository status
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Repository Name: ${{ steps.ecr-repo.outputs.repo_name }}"
          echo "ğŸ“ Region: ${{ env.REGION }}"
          echo "âœ… Already Existed: ${{ steps.ecr-repo.outputs.exists }}"
          echo "ğŸ†• Created Now: ${{ steps.ecr-repo.outputs.created }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ "${{ steps.ecr-repo.outputs.created }}" == "true" ]; then
            echo "âœ… Repository created successfully!"
          else
            echo "âœ… Repository already exists. Nothing to do."
          fi

